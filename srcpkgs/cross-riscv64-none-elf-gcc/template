# Template file for 'cross-riscv-none-elf-gcc'
_triplet=riscv64-none-elf
_pkgname=gcc
pkgname=cross-${_triplet}-${_pkgname}
version=14.2.0
revision=1
short_desc="GNU Compiler Collection - cross compiler for RISC-V (bare-metal) target"
maintainer="Miraris <miraris@autistici.org>"
license="GFDL-1.2-or-later, GPL-3.0-or-later, LGPL-2.1-or-later"
homepage="http://gcc.gnu.org"

distfiles="${GNU_SITE}/gcc/gcc-${version}/gcc-${version}.tar.xz"
checksum=a7b39bc69cbf9e25826c5a60ab26477001f7c08d85cec04bc0e29cabed6f3cc9

build_wrksrc=build
build_style=gnu-configure

hostmakedepends="tar texinfo gmp-devel mpfr-devel libmpc-devel isl-devel zlib-devel libzstd-devel"
makedepends="cross-${_triplet}-binutils cross-${_triplet}-newlib"
depends="cross-${_triplet}-binutils"
conflicts="cross-${_triplet}-gcc-bootstrap"

nocross=yes
nopie=yes
nostrip_files="libgcc.a libgcov.a libgcc_eh.a libc.a libm.a libstdc++.a libsupc++.a libnosys.a crt0.o crti.o crtn.o"

post_extract() {
	mkdir -p build
}

pre_configure() {
	export CFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections"
	export CXXFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections"
}

do_configure() {
	../configure \
		--target=${_triplet} \
		--prefix=/usr \
		--libexecdir=/usr/lib \
		--with-sysroot=/usr/${_triplet} \
		--with-native-system-header-dir=/include \
		--with-python-dir=share/gcc-${_triplet} \
		--enable-languages=c,c++ \
		--enable-threads=single \
		--enable-plugins \
		--enable-multilib \
		--enable-libgcc \
		--enable-gnu-indirect-function \
		--with-newlib \
		--with-gnu-as \
		--with-gnu-ld \
		--with-system-zlib \
		--with-gmp \
		--with-mpfr \
		--with-mpc \
		--with-isl \
		--with-libelf \
		--disable-shared \
		--disable-tls \
		--disable-libmudflap \
		--disable-libssp \
		--disable-libquadmath \
		--disable-libgomp \
		--disable-nls \
		--disable-libffi \
		--disable-decimal-float \
		--disable-libstdcxx-pch \
		--disable-werror
}

pre_build() {
	pre_configure
}

post_install() {
	rm -fr ${DESTDIR}/usr/share/{info,man/man7}
	rm -fr ${DESTDIR}/usr/lib/libcc1.*
}

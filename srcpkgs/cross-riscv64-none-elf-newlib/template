# Template file for 'cross-riscv64-none-elf-newlib'
_triplet=riscv64-none-elf
_pkgname=newlib

pkgname=cross-${_triplet}-${_pkgname}
version=4.4.0.20231231
revision=1
short_desc="C standard library implementation intended for use on embedded systems (RISC-V bare metal)"
maintainer="Miraris <miraris@autistici.org>"
license="BSD-3-Clause"
homepage="https://www.sourceware.org/newlib/"

hostmakedepends="texinfo cross-${_triplet}-binutils cross-${_triplet}-gcc-bootstrap"
nocross=yes
nostrip=yes

distfiles="https://sourceware.org/pub/newlib/newlib-${version}.tar.gz"
checksum="0c166a39e1bf0951dfafcd68949fe0e4b6d3658081d6282f39aeefc6310f2f13"

build_style=gnu-configure
configure_args="
 --prefix=/usr
 --target=${_triplet}
 --enable-newlib-io-long-long
 --enable-newlib-io-c99-formats
 --enable-newlib-register-fini
 --enable-newlib-retargetable-locking
 --disable-newlib-supplied-syscalls
 --disable-nls"

post_extract() {
	mkdir -p build-{newlib,nano}
}

pre_configure() {
	:
}

do_configure() {
	# regular newlib build
	cd build-newlib
	export CFLAGS_FOR_TARGET="-g -O2 -ffunction-sections -fdata-sections"
	../configure ${configure_args}

	# nano variant build
	cd ../build-nano
	export CFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections"
	../configure ${configure_args} \
		--disable-newlib-supplied-syscalls \
		--enable-newlib-reent-small \
		--enable-newlib-retargetable-locking \
		--disable-newlib-fvwrite-in-streamio \
		--disable-newlib-fseek-optimization \
		--disable-newlib-wide-orient \
		--enable-newlib-nano-malloc \
		--disable-newlib-unbuf-stream-opt \
		--enable-lite-exit \
		--enable-newlib-global-atexit \
		--enable-newlib-nano-formatted-io
}

do_build() {
	cd build-newlib
	make ${makejobs}

	cd ../build-nano
	make ${makejobs}
}

do_install() {
	cd build-nano
	make DESTDIR=${DESTDIR} install

	find ${DESTDIR} -regex ".*/lib\(c\|g\|rdimon\)\.a" \
		-exec rename .a _nano.a '{}' \;

	vmkdir usr/${_triplet}/include/newlib-nano
	vinstall ${DESTDIR}/usr/${_triplet}/include/newlib.h 644 \
		usr/${_triplet}/include/newlib-nano

	cd ../build-newlib
	make DESTDIR=${DESTDIR} install

	vlicense ../COPYING
}
